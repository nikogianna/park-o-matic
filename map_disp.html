<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin="" />
  <!-- Make sure you put this AFTER Leaflet's CSS -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
  <!-- <script type="text/javascript" src="https://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script> -->
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>


  <script type="text/javascript" src='map.js'></script>
  <link rel="stylesheet" type="text/css" href="mystyle.css">

  <title>Simple Map</title>
</head>

<body>
  <div id="mapid"></div>
  <button id="circles" type="button">Show Zones</button>
  <button id="zones" type="button">Load Default Zones And Spots</button>
  <!-- <button id="spots" type="button">Load Default Number of Parking Spots</button> -->

  <div id="response">

  </div>
</body>

<script type="text/javascript">
  var geojsonFeature;
  var geojson;
  var centroid;
  var res;
  var inner_radius = 1500;
  var outer_radius = 3000;
  var info;
  var circle1;
  var circle2;
  var centroid1;


  // var Stamen_Toner = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.{ext}', {
  //   attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  //   subdomains: 'abcd',
  //   minZoom: 0,
  //   maxZoom: 20,
  //   ext: 'png'
  // });
  var openmap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map tiles by <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    minZoom: 0
  });
  // var mymap = L.map('mapid').setView([40.627034, 22.954172], 12);
  var mymap = L.map('mapid');
  mymap.fitWorld();

  // L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoibmlrb25pa29naWFubmEiLCJhIjoiY2p4bmU0OW5tMDFsbTNia2Z4OG5iaHlvcyJ9.QBLBmiu_qJ_9nMDnOQJBtA', {
  //   attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
  //   maxZoom: 18,
  //   id: 'mapbox.satellite',
  //   accessToken: 'your.mapbox.access.token'
  // }).addTo(mymap);
  // var layer = new L.StamenTileLayer("toner");
  mymap.addLayer(openmap);

  // mymap.addLayer(Stamen_Toner);
  // L.geoJSON(geojsonFeature).addTo(mymap);
</script>


<script type="text/javascript">
  // var geojsonFeature =
  //   L.geoJSON(geojsonFeature).addTo(mymap);
  // $("button").click(function(e) {
  //   e.preventDefault();
  $(document).ready(function() {
    $.ajax({
      type: "POST",
      url: "/resp.php",
      dataType: 'json',
      data: {
        registration: "success",
        name: "xyz",
        email: "abc@gmail.com"
      },
      success: function(result) {

        geojsonFeature = jQuery.parseJSON(result.abc);
        geojson = L.geoJson(geojsonFeature, {
          style: myStyle,
          onEachFeature: onEachFeature2
        }).addTo(mymap);

        mymap.fitBounds(geojson.getBounds());

        centroid = turf.centroid(geojsonFeature);
        res = String(centroid.geometry.coordinates).split(",");

      },
      error: function(result) {
        alert('error');
      }
    });

    info = L.control({
      position: 'bottomleft'
    });

    info.onAdd = function(mymap) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this.update();
      return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function(polyg) {
      this._div.innerHTML = '<h4>Population And ID</h4>' + (polyg ?
        '<b>ID: ' + polyg.id + '</b><br />' + polyg.population + ' people' :
        'Hover over a polygon');
    };

    info.addTo(mymap);


  });
</script>

<script type="text/javascript">
  $("#circles").click(function(e) {
    e.preventDefault();

    if (geojson !== null) {
      if (!mymap.hasLayer(circle1)) {
        centroid1 = L.geoJSON(centroid).addTo(mymap);

        circle1 = L.circle([res[1], res[0]], {
          radius: outer_radius,
          'fillColor': "#d5dce6",
          'fillOpacity': 0.35,
          "color": "black",
          "weight": 4,
          "opacity": 0.55
        }).addTo(mymap);

        circle2 = L.circle([res[1], res[0]], {
          radius: inner_radius,
          'fillColor': "#8296b5",
          'fillOpacity': 0.75,
          "color": "black",
          "weight": 4,
          "opacity": 0.55
        }).addTo(mymap);

        $("#circles").html('Hide Zones');
        // var marker = L.marker([40.64316461309677, 22.93441007414772]).addTo(mymap);

      } else {
        mymap.removeLayer(circle1);
        mymap.removeLayer(circle2);
        mymap.removeLayer(centroid1);
        $("#circles").html('Show Zones');

      }
    }

    // var testvar = geojson.getLayers();
    // for (var incid of testvar) { /* do stuff */
    //   alert(incid.feature.properties.id.
    //     '  '.incid.feature.geometry);
    // }

    // alert(geojsonFeature.features[0].properties.centroid);

    // var marker = L.marker([40.58798254168363, 22.97053825267842]).addTo(mymap);



  });


  $("#zones").click(function(e) {
    e.preventDefault();

    var zones = [];
    var spots = [];
    var ids = [];

    if (geojsonFeature !== null) {

      for (var i = 0; i < geojsonFeature.features.length; i++) {
        var properties = geojsonFeature.features[i].properties;
        ids[i] = properties.id
        var population = properties.population;
        var centre = properties.centroid;
        var latlng_point = L.latLng(res[1], res[0]);
        var latlng_centroid = L.latLng(centre.coordinates[1], centre.coordinates[0]);
        // alert(centre.distanceTo(centroid));
        // L.geoJSON(centre).addTo(mymap);
        // alert(centre);
        // alert(latlng_point.distanceTo(latlng_centroid));
        var dist = latlng_point.distanceTo(latlng_centroid);
        if (dist <= 1500) {
          zones[i] = 'kentro';
          var coef = 1;
        } else if (dist > 1500 && dist <= 3000) {
          zones[i] = 'home';
          var coef = 2;
        } else {
          zones[i] = 'steady';
          var coef = 3;
        }

        spots[i] = Math.ceil(coef * (population / 3));
      }
    }

    var jsonZones = JSON.stringify(zones);
    var jsonSpots = JSON.stringify(spots);
    var jsonIDs = JSON.stringify(ids);
    // alert(jsonString);
    $.ajax({
      type: "POST",
      url: "/resp2.php",
      data: {
        registration: "success",
        zones: jsonZones,
        spots: jsonSpots,
        ids: jsonIDs
      },
      success: function(result) {

        // alert("Zones are now loaded on the DB");
        alert(result);

      },
      error: function(result) {
        alert('error');
      }
    });
  });
</script>

</html>